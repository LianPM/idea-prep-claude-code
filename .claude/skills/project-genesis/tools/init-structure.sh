#!/bin/bash
# Project Genesis: Initialize .claude/ structure with memory system
# Usage: ./init-structure.sh [project-name]

set -e

PROJECT_NAME="${1:-my-project}"
TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")

echo "üèóÔ∏è  Project Genesis: Initializing structure..."
echo "   Project: $PROJECT_NAME"
echo ""

# Directory structure
DIRS=(
  ".claude/agents"
  ".claude/commands"
  ".claude/docs"
  ".claude/memory"
  ".claude/skills"
)

# Create directories
for dir in "${DIRS[@]}"; do
  if [ ! -d "$dir" ]; then
    mkdir -p "$dir"
    echo "  ‚úÖ Created $dir"
  else
    echo "  ‚è≠Ô∏è  $dir exists"
  fi
done

# Initialize memory files
echo ""
echo "üìù Initializing memory system..."

# context.md - Current project state
if [ ! -f ".claude/memory/context.md" ]; then
  cat > ".claude/memory/context.md" << EOF
# Project Context

**Project**: $PROJECT_NAME
**Phase**: planning
**Current Feature**: None
**Last Updated**: $TIMESTAMP

## Recent Changes
- Project initialized with Project Genesis

## Current Focus
Awaiting first feature planning. Run \`/develop plan\` to begin.

## Session Notes
(Add notes during development sessions)
EOF
  echo "  ‚úÖ Created context.md"
else
  echo "  ‚è≠Ô∏è  context.md exists"
fi

# tasks.md - Task board
if [ ! -f ".claude/memory/tasks.md" ]; then
  cat > ".claude/memory/tasks.md" << EOF
# Task Board

## Backlog
(Tasks will appear here after planning)

## In Progress
(No active tasks)

## Done
- [x] \`init-001\`: Initialize project structure [completed: $TIMESTAMP]

---
*Updated: $TIMESTAMP*
EOF
  echo "  ‚úÖ Created tasks.md"
else
  echo "  ‚è≠Ô∏è  tasks.md exists"
fi

# decisions.md - Architectural Decision Records
if [ ! -f ".claude/memory/decisions.md" ]; then
  cat > ".claude/memory/decisions.md" << EOF
# Architectural Decision Records

## ADR-001: Project Initialization
- **Date**: $TIMESTAMP
- **Status**: accepted
- **Context**: Starting new project with Project Genesis
- **Decision**: Use standard .claude/ structure with memory system
- **Consequences**:
  - Agents can share context via memory files
  - Decisions are tracked for future reference
  - Sessions can be resumed with full context

---

## Template for New ADRs

\`\`\`markdown
## ADR-{number}: {title}
- **Date**: {timestamp}
- **Status**: proposed | accepted | deprecated | superseded
- **Context**: {why this decision is needed}
- **Decision**: {what was decided}
- **Alternatives Considered**: {other options}
- **Consequences**: {impact of this decision}
\`\`\`
EOF
  echo "  ‚úÖ Created decisions.md"
else
  echo "  ‚è≠Ô∏è  decisions.md exists"
fi

# handoffs.md - Agent communication log
if [ ! -f ".claude/memory/handoffs.md" ]; then
  cat > ".claude/memory/handoffs.md" << EOF
# Agent Handoff Log

Track agent-to-agent communications and work transfers.

---

## $TIMESTAMP - System ‚Üí Manager
**Type**: Initialization
**Context**: Project Genesis completed structure setup
**Action Required**: Run \`/develop plan\` to begin feature planning

---

## Handoff Template

\`\`\`markdown
## {timestamp} - {from-agent} ‚Üí {to-agent}
**Type**: {build-complete | review-feedback | escalation | status-update}
**Task**: {task-id if applicable}
**Context**: {what was done, current state}
**Action Required**: {what the receiving agent should do}
**Files**: {relevant files if any}
\`\`\`
EOF
  echo "  ‚úÖ Created handoffs.md"
else
  echo "  ‚è≠Ô∏è  handoffs.md exists"
fi

# .gitignore for memory folder (keep structure, ignore contents optionally)
if [ ! -f ".claude/memory/.gitignore" ]; then
  cat > ".claude/memory/.gitignore" << EOF
# Uncomment to ignore memory files from git
# *.md
# !.gitignore

# Always ignore
*.tmp
*.bak
.DS_Store
EOF
  echo "  ‚úÖ Created memory/.gitignore"
fi

# Placeholder docs
echo ""
echo "üìö Setting up documentation..."

if [ ! -f ".claude/docs/ARCHITECTURE.md" ]; then
  cat > ".claude/docs/ARCHITECTURE.md" << EOF
# Architecture: $PROJECT_NAME

> This document will be populated by Project Genesis based on your idea.

## System Overview
(To be defined)

## Component Architecture
(To be defined)

## Data Flow
(To be defined)

## API Design
(To be defined)

## Security Model
(To be defined)

---
*Generated by Project Genesis - $TIMESTAMP*
EOF
  echo "  ‚úÖ Created ARCHITECTURE.md placeholder"
else
  echo "  ‚è≠Ô∏è  ARCHITECTURE.md exists"
fi

if [ ! -f ".claude/docs/RULES.md" ]; then
  cat > ".claude/docs/RULES.md" << EOF
# Development Rules: $PROJECT_NAME

> All agents MUST read this file before writing code.

## Code Standards
- (To be defined based on tech stack)

## Security Requirements
- Never commit secrets or API keys
- Validate all user input
- Use parameterized queries for databases
- Follow principle of least privilege

## Testing Requirements
- (To be defined)

## Git Workflow
- Commit messages: \`type(scope): description\`
- Types: feat, fix, docs, refactor, test, chore
- Keep commits atomic and focused

---
*Generated by Project Genesis - $TIMESTAMP*
EOF
  echo "  ‚úÖ Created RULES.md placeholder"
else
  echo "  ‚è≠Ô∏è  RULES.md exists"
fi

echo ""
echo "‚ú® Project Genesis initialization complete!"
echo ""
echo "Structure created:"
echo "  .claude/"
echo "  ‚îú‚îÄ‚îÄ agents/        (agent definitions)"
echo "  ‚îú‚îÄ‚îÄ commands/      (slash commands)"
echo "  ‚îú‚îÄ‚îÄ docs/          (ARCHITECTURE.md, RULES.md)"
echo "  ‚îú‚îÄ‚îÄ memory/        (context, tasks, decisions, handoffs)"
echo "  ‚îî‚îÄ‚îÄ skills/        (reusable skills)"
echo ""
echo "Next steps:"
echo "  1. Run /idea [your project description] to generate agents"
echo "  2. Or run /develop plan to start planning manually"
echo ""
